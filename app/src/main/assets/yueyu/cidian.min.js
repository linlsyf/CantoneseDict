function cdSearch(term){msg = document.getElementById("msg");clearResults();title = document.title;if(title.match(/ \- /)){replaceTitle = title.replace(/^.*? \- /,"");document.title = term+" - "+replaceTitle}else if(term!= ""){document.title = term+" - "+document.title}if(term == ""){msg.innerHTML = "<p class='msg'>請輸入關鍵詞！</p>"}else if(term == "\$" || term == "\|" || term == "\." || term == "，"){msg.innerHTML = "<p class='msg'>無效的參數名稱。</p>"}else if(window.chaxun.value == "py"){doPysearch(term)}else{msg.innerHTML = "<p class='msg'><a class='results_sw' href='?"+term+"'>"+term+"</a></span><span class='results_msg'> - 搜索結果</span></p>";hanziSearch(term)}}function hanziSearch(term){var sanitized = term.replace(/[^一-龜]/g,"");if(sanitized.length!= 0){ziSearch(sanitized);smySearch(term);ycSearch(term);lijuSearch(term)}else{msg = document.getElementById("msg");msg.innerHTML = "<p class='msg'>找不到相應的詞條。</p>";window.searchbar.focus()}}function ycSearch(term){out = document.getElementById("ycoutput");if(yueci.match(term)){doSearch(term,out)}}function doPysearch(term){out = document.getElementById("ycoutput");if(!term.match(/[a-zA-Z]/)){out.innerHTML = "無效的參數名稱。"}else if(!term.match(/\d/)){noToneSearch(term,out)}else{toneSearch(term,out)}}function toneSearch(term,out){searchTerm = pytoEight(term);if(searchTerm == ""){searchTerm = "無效的參數名稱。"}else{doSearch(searchTerm,out)}}function formatHeaders(htitles,prefix){var headers = "<tr>";for(i=0;i<htitles.length;i++){colclass = prefix+"-"+i.toString();thclass = "<th class='"+colclass+"'>";headers+= thclass+htitles[i]+"</th>"}headers+= "</tr>";return headers}function noToneSearch(term,out){var htitles = ["粵語","拼音","定義","註釋","又作","又音"];var headers = formatHeaders(htitles,"cd");var dictname = "<h2>口語</h2>";var results = "<table>"+headers;var yarr = yueci.split("\$");for(var i=0;i<yarr.length;i++){citiao = yarr[i];raweight = citiao.split("\|")[1];if(raweight){convertedPy = convertPy(raweight);notonePy = convertedPy.replace(/\d/g,"");if(notonePy.match(term)){results+= formatResult(yarr[i],"cd")}}}out.innerHTML = dictname+results+"</table>";setFj();window.searchbar.blur()}function doSearch(term,out){var htitles = ["粵語","拼音","定義","註釋","又作","又音"];var headers = formatHeaders(htitles,"cd");var dictname = "<h2>方言詞</h2>";var results = "<table>"+headers;var yarr = yueci.split("\$");for(var i=0;i<yarr.length;i++){if(yarr[i].match(term)){results+= formatResult(yarr[i],"cd")}}out.innerHTML = dictname+results+"</table>";setFj();window.searchbar.blur();cleanupCols(5,"cd");cleanupCols(4,"cd");cleanupCols(3,"cd")}function formatResult(resultLine,prefix){rsplit = resultLine.split("|");lineout = "<tr><td class='"+prefix+"-0'>";for(var i=0;i<rsplit.length;i++){colclass = prefix+"-"+(i+1).toString();tdclass = "<td class='"+colclass+"'>";w = rsplit[i];if(i == 0){lineout+= "<a href='?"+w+"'>"+w+"</a></td>"+tdclass}else if(i == 1){lineout+= convertPy(w)+"</td>"+tdclass}else if(i == 5){tdclass = "";multic = multiPy(w);lineout+= multic+"</td>"+tdclass}else if(i == 4 && prefix == "smy"){multic = multiPy(w);lineout+= multic+"</td>"+tdclass}else if(i == 2 && prefix.match(/cd|zd/)){oncommas = w.split("，");links = "";for(var l = 0;l < oncommas.length;l++){ltext = oncommas[l];if(l!= 0){links+= "，"}links+= "<a href='?"+ltext+"'>"+ltext+"</a>"}lineout+= links+"</a></td>"+tdclass}else if(i == rsplit.length -1){lineout+= w+"</td>"}else{lineout+= w+"</td>"+tdclass}}return lineout+"</td></tr>"}function multiPy(w){if(/，/.test(w)){wsplit = w.split("，");multic = [];for(var c = 0;c < wsplit.length;c++){multic.push(convertPy(wsplit[c]))}return multic.join("，")}else{return convertPy(w)}}function enterSubmit(e){var keynum = e.keyCode;if(/13/.test(keynum)){term = window.searchbar.value;oldterm = getQueryString();cdSearch(term);window.history.pushState({term:oldterm},oldterm,"?"+term);console.log("pushed:"+oldterm)}}function convertPy(py){segments = py.match(/.{1,2}/g);currentpy = localStorage.getItem("currentpy");if(!currentpy){currentpy = "yale"}pysplit = window[currentpy].split(" ");esplit = eight.split(" ");yout = [];if(segments){for(var i = 0;i < segments.length;i++){s = segments[i];ind = esplit.indexOf(s);yout.push(pysplit[ind])}}return yout.join(" ")}function traversePy(frompy,topy,prefix){pycols = [prefix+"-1",prefix+"-5"];if(prefix == "smy"){pycols = [prefix+"-1",prefix+"-4"]}for(var c = 0;c < pycols.length;c++){allpy = document.getElementsByClassName(pycols[c]);for(var i=0;i<allpy.length;i++){if(allpy[i].nodeName == "TH") continue;pytxt = allpy[i].textContent;travout = "";if(/，/.test(pytxt)){travout = multTraverse(pytxt,frompy,topy)}else{travout = singleTraverse(pytxt,frompy,topy)}allpy[i].innerHTML = travout}}}function switchPy(pytype){currentpy = localStorage.getItem("currentpy");if(!currentpy){currentpy = "yale"}frompy = window[currentpy].split(" ");topy = window[pytype].split(" ");prefixes = ["zd","smy","cd"];for(h = 0;h < prefixes.length;h++){traversePy(frompy,topy,prefixes[h])}localStorage.setItem("currentpy",pytype)}function multTraverse(pytxt,frompy,topy){psplit = pytxt.split("，");outlist = [];for(var c=0;c<psplit.length;c++){w = psplit[c];wsplit = w.split(" ");outpy = [];for(var p=0;p<wsplit.length;p++){ind = frompy.indexOf(wsplit[p]);pout = topy[ind];outpy.push(pout)}console.log(outlist);outlist.push(outpy.join(" "))}return outlist.join("，")}function singleTraverse(pytxt,frompy,topy){psplit = pytxt.split(" ");outpy = [];for(var p=0;p<psplit.length;p++){ind = frompy.indexOf(psplit[p]);pout = topy[ind];outpy.push(pout)}return outpy.join(" ")}function pytoEight(py){pysplit = py.split(" ");currentpy = localStorage.getItem("currentpy");if(!currentpy){currentpy = "yale"}frompy = window[currentpy].split(" ");topy = eight.split(" ");outpy = [];for(var i=0;i<pysplit.length;i++){pysyll = pysplit[i];ind = frompy.indexOf(pysyll);pout = topy[ind];outpy.push(pout)}finalpy = outpy.join("");return finalpy}function switchFj(fjType){localStorage.setItem("currentfj",fjType);if(fjType == "f2j"){traverseFj(fanjian)}else if(fjType == "j2f"){term = getQueryString();cdSearch(term)}}function switchCx(searchType){localStorage.setItem("currentcx",searchType);term = getQueryString();cdSearch(term)}function traverseFj(fjVar){alltd = document.getElementsByTagName("td");for(var i=0;i<alltd.length;i++){outtxt = alltd[i].textContent;for(var f=0;f<fjVar.length;f++){re = new RegExp(fjVar[f][0],"g");outtxt = outtxt.replace(re,fjVar[f][1])}alltd[i].innerHTML = outtxt}}function initpref(){currentpy = localStorage.getItem("currentpy");if(!currentpy){currentpy = "yale"}currentfj = localStorage.getItem("currentfj");if(!currentfj){currentfj = "j2f"}currentcx = localStorage.getItem("currentcx");if(!currentcx){currentcx = "hz"}window.pingyam.value = currentpy;window.ziti.value = currentfj;window.chaxun.value = currentcx;accessApi()}function setFj(){currentfj = localStorage.getItem("currentfj");if(currentfj == "f2j"){switchFj("f2j")}}function getQueryString(){query = window.location.search.substring(1);queryString = decodeURI(query);return queryString}function accessApi(){queryString = getQueryString();if(queryString == ""){window.searchbar.focus()}else{cdSearch(queryString)}}function cleanupCols(num,prefix){colnum = prefix+"-"+num.toString();col = document.getElementsByClassName(colnum);isempty = true;for(i = 1;i < col.length;i++){if(col[i].textContent!= ""){isempty = false}}if(isempty){for(i = 0;i < col.length;i++){col[i].style.display = "none"}}}function searchDict(term,zarr,prefix){var resultString = "";var re = new RegExp("^"+term);for(var i=0;i<zarr.length;i++){if(zarr[i].match(re)){resultString+= formatResult(zarr[i],prefix)}}return resultString}function zdDosearch(term,zarr,prefix){getResults = "";if(term.length>1){zsplit = term.split("");for(i=0;i<zsplit.length;i++){getResults+= searchDict(zsplit[i],zarr,prefix)}}else{getResults = searchDict(term,zarr,prefix)}return getResults}function ziSearch(term){var out = document.getElementById("yzoutput");var htitles = ["繁體","拼音","詞例","定義","又作","又音"];var headers = formatHeaders(htitles,"zd");var dictname = "<h2>字音</h2>";var results = "<table>"+headers;var zarr = yuezi.split("\$");var noresults = true;var prefix = "zd";resultString = zdDosearch(term,zarr,prefix);if(resultString!= ""){noresults = false}results+= resultString;if(!noresults){out.innerHTML = dictname+results+"</table>"}cleanupCols(5,"zd");cleanupCols(4,"zd");cleanupCols(3,"zd");cleanupCols(2,"zd")}function smySearch(term){var out = document.getElementById("smyoutput");var htitles = ["繁體","拼音","註釋","又作","又音"];var headers = formatHeaders(htitles,"smy");var dictname = "<h2>書面語</h2>";var results = "<table>"+headers;var sarr = shumianyu.split("\$");var prefix = "smy";var resultString = "";for(var i=0;i<sarr.length;i++){if(sarr[i].match(term)){resultString+= formatResult(sarr[i],"smy")}}if(resultString!= ""){results+= resultString;out.innerHTML = dictname+results+"</table>"}cleanupCols(4,"smy");cleanupCols(3,"smy");cleanupCols(2,"smy")}function lijuSearch(term){var out = document.getElementById("ljoutput");var htitles = ["粵語","國語"];var headers = formatHeaders(htitles,"lj");var dictname = "<h2>例句</h2>";var results = "<table>"+headers;var larr = liju.split("\$");var noresults = true;for(var i=0;i<larr.length;i++){if(larr[i].match(term)){noresults = false;resultLine = larr[i];rsplit = resultLine.split("|");yue = rsplit[0];guo = rsplit[1];lineout = "<tr><td class='lj-0'>"+yue+"</td><td class='lj-1'>"+guo+"</td>";results+= lineout}}if(!noresults){out.innerHTML = dictname+results+"</table>"}}function clearResults(){results = document.getElementsByClassName("results");for(i=0;i<results.length;i++){results[i].innerHTML = ""}}function getHome(){clearResults();document.title = document.title.replace(/.* \- /,"")}window.addEventListener('popstate',function(event){if(history.state && history.state.term){term = history.state.term;if(term == ""){getHome()}else{cdSearch(term);document.title = term+" - "+document.title.replace(/.* \- /,"")}}else{getHome()}},false);